<% include ../partials/header.ejs %>

<div class="panel panel-default">
  <div class="panel-heading">
    <a href='<%= user.companyUrl %>' target="_blank" style="font-size: 1.5em;">
      <%= article.title.nickname %>
    </a>
    <div style="float: right;">
       작성일 :
       <% if(article.createdAt === article.updatedAt) { %>
        <%= article.getDate.year %> -
        <%= article.getDate.month %> -
        <%= article.getDate.day %>
      <% } else { %>
        <%= article.getDate.year %> -
        <%= article.getDate.month %> -
        <%= article.getDate.day %>
        (수정된 날짜 : <%= article.updatedDate.year %> -
        <%= article.updatedDate.month %> -
        <%= article.updatedDate.day %>)
      <% } %>
      </div>
  </div>
  <div class="panel-body">
      <% if (article.thumbnail) { %>
        <p>
          <img src="https://wpsn-younghea-zigzeg.s3.amazonaws.com/<%= article.thumbnail %>" style="max-width: 100%; height: auto;">
        </p>
      <% } %>

      <%- article.content %>
    </div>
    <!-- 요청사항 영역  -->

    <hr />
    <div>
      <table class="table" id="comment_area">
        <tr>
          <th>요청 내용</th>
          <th>작성자</th>
          <th>작성일</th>
          <th>삭제 여부 밑 댓글달기</th>
        </tr>
        <% if(comments == null || comments.length == 0) { %>
          <tr>
            <td colspan=100 style="text-align: center;">요청사항이 없습니다.</td>
          </tr>
        <% } %>
        <% comments.forEach((comment) => { %>
          <tr>
            <td>
              <%= comment.content %>
            </td>
            <td>
              <%= comment.writer.nickname %>
            </td>
            <td>
              <%= comment.getDate.year %> - <%= comment.getDate.month %> - <%= comment.getDate.day %>
            </td>
            <td>
              <button type="button" class='comment_delete' comment_id='<%= comment._id%>'>삭제</button>
              <% if(users.admin === true) { %>
                및 <button type="button" class="answerBtn">댓글달기</button>
              <% } %>
            </td>
          </tr>
          <tr id="answer" class="off">
            <td colspan="4">
              <div>
                댓글 작성하기
                <form id="answerForm" action="" method="post">
                  <textarea class="form-control" name="content"></textarea>
                  <button type="submit" class="btn btn-primary addAnswerBtn" style="margin-top: 10px" id="answerButton" comment_id='<%= comment._id%>'>댓글 작성</button>
                </form>
              </div>
            </td>
          </tr>
        <% }) %>
      </table>
    </div>

    <!-- 요청사항 영역  -->
    <div>
      요청사항 작성하기
      <form id="commentForm" action="" method="post">
        <input type="hidden" name="shoppingMall_id" value="<%=article._id%>" />
        <textarea class="form-control" name="content"></textarea>
        <button class="btn btn-primary addCommentBtn" style="margin-top: 10px">요청사항 작성</button>
      </form>
    </div>
    <!-- 요청사항 영역  -->

  </div>

  <a href="/delete/<%= article._id %>" class="btn btn-danger" onclick="return confirm('삭제하시겠습니까?')">삭제</a>
  <% if(article.title === user._id) { %>
    <a href="/shoppingmall/edit/<%= article._id %>" class="btn btn-primary">수정</a>
  <% } %>
</div>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>

<style>
  .off {
    display: none;
  }
</style>

<script>
  $(function () {
    $('button.answerBtn').click(
      function (e) {
        $("#answer").toggleClass('off');
      })
  });
  $(document).on('click', '.addCommentBtn', function () {
      let $contentVal = $(this).siblings('textarea[name=content]').val();
      if ($contentVal) {
        $.ajax({
          url: '/shoppingmall/ajax_comment/insert',
          type: 'POST',
          data: $(this).serialize(),
        })
          .done(function (args) {
            if (args.message === "success") {
              $('#comment_area').append(
                '<tr>' + '<td>' + args.content + '</td>' + '<td>' + args.writer + '</td>' + '<td>' + args.getDate + '</td>' + "<td> <a class='comment_delete' comment_id='" +
                args.id + "'>삭제</a> </td> </tr>"
              );
              $('#commentForm textarea[name=content]').val("");
              window.location.reload()
            }
          })
          .fail(function (args) {
            console.log(args);
          });
      } else {
        alert('요청사항을 입력해주세요.')
      }
      return false;
    });
// 이부분 오류( ajax 요청이 다른 곳으로 보내서 요청사항에 대한 댓글을 달수 없는 오류가 발생 )
    $(document).on('click', '.addAnswerBtn', function () {
      let $contentVal = $(this).siblings('textarea[name=content]').val();
      if (!$contentVal) {
        alert('요청사항을 입력해주세요.');
        return false;
      }
      $.ajax({
        url: '/shoppingmall/ajax_comment/answer',
        type: 'POST',
        data: [$(this).serialize(), { comment_id: $self.attr('comment_id') }],
      })
        .done(function (args) {
          if (args.message === "success") {
            $('#comment_area').append( '<tr>' + '<td>' + args.content + '</td>' + '<td>' + args.writer + '</td>' + "</tr>" );
            $('#answerForm textarea[name=content]').val("");
            window.location.reload()
          }
        })
        .fail(
          function (args) {
            console.log(args);
          }
        );
    });

    $(document).on('click', '.comment_delete', function () {
      if (confirm('삭제하시겠습니까?')) { //확인창 예 눌렀을 시만 진행
        let $self = $(this);
        $.ajax({
          url: '/shoppingmall/ajax_comment/delete',
          type: 'POST',
          data: { comment_id: $self.attr('comment_id') },
        })
          .done(function (args) {
            if(args.message === "success"){
              $self.parent().remove();
              window.location.reload();
              alert("삭제가 완료되었습니다.");
            }
          })
          .fail(function (args) {
            console.log(args);
          });
      }
    });

</script>

<% include ../partials/footer.ejs %>